<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSearch Query Application</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OpenSearch Query Application</h1>
            <p>Search and export data from your OpenSearch cluster</p>
        </div>

        <div class="search-form">
            <form id="searchForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="region">Region *</label>
                        <select id="region" name="region" required>
                            {% for region in regions %}
                            <option value="{{ region }}" {% if region == "A" %}selected{% endif %}>{{ region }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="business_area">Business Area *</label>
                        <select id="business_area" name="business_area" required>
                            {% for area in business_areas %}
                            <option value="{{ area }}" {% if area == "A" %}selected{% endif %}>{{ area }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="data_source">Data Source *</label>
                        <select id="data_source" name="data_source" required>
                            {% for source in data_sources %}
                            <option value="{{ source }}" {% if source == "A" %}selected{% endif %}>{{ source }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="trade_date_from">Trade Date From *</label>
                        <input type="date" id="trade_date_from" name="trade_date_from" required>
                    </div>

                    <div class="form-group">
                        <label for="trade_date_to">Trade Date To *</label>
                        <input type="date" id="trade_date_to" name="trade_date_to" required>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>

        <div class="results-container" id="resultsContainer" style="display: none;">
            <div class="results-header">
                <div class="results-count" id="resultsCount"></div>
                <button class="btn btn-primary" onclick="exportCSV()" id="exportBtn">
                    Export to CSV
                </button>
            </div>

            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        let currentParams = {};
        let isLoading = false;

        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('resultsContent').innerHTML = '';
            await executeSearch();
        });

        async function executeSearch() {
            if (isLoading) return;

            const form = document.getElementById('searchForm');
            const formData = new FormData(form);

            // Get all form values
            const region = formData.get('region');
            const businessArea = formData.get('business_area');
            const dataSource = formData.get('data_source');
            const tradeDateFrom = formData.get('trade_date_from');
            const tradeDateTo = formData.get('trade_date_to');

            // Validate all required fields
            if (!tradeDateFrom || !tradeDateTo) {
                alert('Please select both Trade Date From and Trade Date To');
                return;
            }

            // Validate date range
            if (new Date(tradeDateFrom) > new Date(tradeDateTo)) {
                alert('Trade Date From must be earlier than or equal to Trade Date To');
                return;
            }

            currentParams = {
                region: region,
                business_area: businessArea,
                data_source: dataSource,
                trade_date_from: tradeDateFrom,
                trade_date_to: tradeDateTo
            };

            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');

            isLoading = true;
            resultsContainer.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const queryParams = new URLSearchParams();
                queryParams.append('region', currentParams.region);
                queryParams.append('business_area', currentParams.business_area);
                queryParams.append('data_source', currentParams.data_source);
                queryParams.append('trade_date_from', currentParams.trade_date_from);
                queryParams.append('trade_date_to', currentParams.trade_date_to);
                queryParams.append('page', '1');

                console.log('Search URL:', `/search?${queryParams.toString()}`);

                const response = await fetch(`/search?${queryParams.toString()}`, {
                    signal: AbortSignal.timeout(300000)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                displayResults(data);
            } catch (error) {
                if (error.name === 'TimeoutError') {
                    resultsContent.innerHTML = `<div class="no-results">Search timed out after 5 minutes. Please try narrowing your search criteria.</div>`;
                } else {
                    resultsContent.innerHTML = `<div class="no-results">Error: ${error.message}</div>`;
                }
            } finally {
                isLoading = false;
            }
        }

        function displayResults(data) {
            const resultsCount = document.getElementById('resultsCount');
            const resultsContent = document.getElementById('resultsContent');

            resultsCount.textContent = `Total Results: ${data.total} (showing max 100)`;

            if (data.results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3>No results found</h3>
                        <p>Try adjusting your search criteria</p>
                    </div>
                `;
                return;
            }

            const headers = ['tradeID', 'tradeIdInternal', 'primaryAssetClass', 'sourceSystemName', 'tradeDate'];

            let tableHTML = '<div class="table-wrapper"><table class="results-table"><thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            data.results.forEach(result => {
                tableHTML += '<tr>';
                headers.forEach(header => {
                    const value = result[header] || '';
                    const escapedValue = escapeHtml(String(value));
                    tableHTML += `<td title="${escapedValue}">${escapedValue}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table></div>';
            resultsContent.innerHTML = tableHTML;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function resetForm() {
            document.getElementById('searchForm').reset();
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('resultsContent').innerHTML = '';
        }

        async function exportCSV() {
            const queryParams = new URLSearchParams();
            queryParams.append('region', currentParams.region);
            queryParams.append('business_area', currentParams.business_area);
            queryParams.append('data_source', currentParams.data_source);
            queryParams.append('trade_date_from', currentParams.trade_date_from);
            queryParams.append('trade_date_to', currentParams.trade_date_to);

            window.location.href = `/export?${queryParams.toString()}`;
        }
    </script>
</body>
</html>